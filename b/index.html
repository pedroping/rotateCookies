<html>

<body>
  <h1>site 2</h1>

  <div>
    <span>Current</span>
    <span id="token"></span>
  </div>

  <br>

  <input type="text" id="token">
  <button id="set">Set</button>
  <button id="clear">Clear</button>
  <iframe id='commonSite' src='https://rotatecookies.onrender.com/c/commonSite.html' style='display: none;'></iframe>

  <script>
    (function () {
      const commonSite = document.querySelector('#commonSite').contentWindow;
      const tokenInput = document.querySelector("#token");
      const setBtn = document.querySelector("#set");
      const clearBtn = document.querySelector("#clear");
      const commonOrigin = 'https://rotatecookies.onrender.com';
      const frame = document.querySelector('#commonSite');
      const tokenSpan = document.querySelector("#token");

      const lastUrl = new URLSearchParams(window.location.search).get('url');

      clearBtn.addEventListener('click', () => {
        commonSite.postMessage({
          action: 'set',
          token: ''
        }, commonOrigin);
      })


      setBtn.addEventListener('click', () => {
        if (!tokenInput.value) return;

        commonSite.postMessage({
          action: 'set',
          token: tokenInput.value
        }, commonOrigin);
      })

      window.addEventListener(
        "message",
        (event) => {
          if (event?.data?.type == 'token' && !event?.data?.invalid) {
            tokenSpan.innerText = event.data.token;
          }

          if (event.data.wappalyzer) return;
          if (event.data !== 'ok') return;

          if (confirm('Token saved! Go to the main page?'))
            window.location.href = lastUrl || 'https://pedroping.github.io/rotateCookies/a'
        },
        false,
      );

      frame.onload = () => {
        commonSite.postMessage({
          action: 'get'
        }, commonOrigin);
      }
    })();
  </script>
</body>

</html>