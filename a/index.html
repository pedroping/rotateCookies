<html>

<body>
  <h1>site 1</h1>
  <br />
  <span id="token"></span>
  <button id="clearBtn">Clear</button>
  <iframe id='commonSite' src='https://wonderful-mooncake-705915.netlify.app/c/commonsite'
    style='display: none;'></iframe>

  <script>
    const clearBtn = document.querySelector('#clearBtn');
    const commonOrigin = 'https://wonderful-mooncake-705915.netlify.app';
    const commonSite = document.querySelector('#commonSite').contentWindow;

    clearBtn.addEventListener('click', () => {
      commonSite.postMessage({
        action: 'set',
        token: null
      }, commonOrigin);
    })


    function getCookie(cname) {
      let name = cname + "=";
      let decodedCookie = decodeURIComponent(document.cookie);
      let ca = decodedCookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }

    (function () {
      const frame = document.querySelector('#commonSite');
      const commonSite = frame.contentWindow;
      const tokenSpan = document.querySelector("#token");

      const cookie = getCookie("myToken");

      if (cookie) {
        tokenSpan.innerText = cookie;
        return;
      }

      window.addEventListener(
        "message",
        (event) => {
          if (event?.data?.type != 'token') return;

          if (event.data.invalid) {
            window.location.href = 'https://wonderful-mooncake-705915.netlify.app/b?url=' + window.location.href;
            return
          }

          tokenSpan.innerText = event.data.token;
        },
        false,
      );


      frame.onload = () => {
        commonSite.postMessage({
          action: 'get'
        }, commonOrigin);
      }
    })();
  </script>
</body>

</html>